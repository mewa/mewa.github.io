<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  
  <title>Polyglot assembly 101</title>
  <meta property="og:title" content="Polyglot assembly 101" />
  <meta name="twitter:title" content="Polyglot assembly 101" />
  

  
  <meta name="description" content="This is where I share some of the things I happen to find interesting or helpful otherwise">
  <meta property="og:description" content="This is where I share some of the things I happen to find interesting or helpful otherwise">
  <meta name="twitter:description" content="This is where I share some of the things I happen to find interesting or helpful otherwise">
  

  <meta name="author" content="Marcin Chmiel"/>
  <meta property="og:site_name" content="Marcin Chmiel" />
  <meta property="og:url" content="https://marcinchmiel.com/articles/2017-07/polyglot-assembly-101/" />

  
  <meta name="twitter:card" content="summary" />

  
  <meta name="twitter:site" content="@marcin_chm" />
  <meta name="twitter:creator" content="@marcin_chm" />
  

  
  <meta property="og:type" content="article" />
  
  
  
  <meta name="generator" content="Hugo 0.63.2" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-99152208-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  <meta property="og:title" content="Polyglot assembly 101" />
<meta property="og:description" content="As promised in my somewhat lengthy &ldquo;Hello World&rdquo; post, although much later than intended, I finally got down to writing a follow-up post.
I remember one of the very first lectures during my uni course &ndash; when assembly language was being introduced. Nothing too deep, really. However, I recall a statement being made, that probably still lives in the minds of the many that heard it (and perhaps even more that didn&rsquo;t). Namely &ndash; that assembly code is not portable.
In this post we&rsquo;re going to take a look at how misleading that statement is and explore writing polyglot assembly code." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://marcinchmiel.com/articles/2017-07/polyglot-assembly-101/" />
<meta property="article:published_time" content="2017-07-31T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-07-31T00:00:00+00:00" />

  
  
  <link rel="stylesheet" href="https://marcinchmiel.com/css/style.css" />
  
  
  
  <script type="text/javascript" src="https://marcinchmiel.com/js/bundle.js"></script>
  

</head>

<body>
  <a href="#main" class="skip-link p-screen-reader-text">Skip to content</a>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;" aria-hidden="true"> <symbol id="icon-500px" viewBox="0 0 16 16"><g> <path d="M3.953 10.512a5.24 5.24 0 0 0 6.996 3.141c.625-.262 1.184-.641 1.666-1.122s.859-1.041 1.122-1.666c.272-.647.412-1.331.412-2.037s-.137-1.394-.412-2.037c-.262-.625-.641-1.184-1.122-1.666s-1.041-.859-1.666-1.122a5.226 5.226 0 0 0-2.037-.413c-.716 0-1.431.144-2.066.413-.509.216-1.372.769-1.875 1.291l-.003.003V.984h7.241c.262-.003.262-.372.262-.491 0-.122 0-.487-.266-.491H4.377a.343.343 0 0 0-.344.341v6.066c0 .197.244.338.472.384.444.094.544-.047.653-.197l.016-.019c.166-.247.681-.766.688-.772a4.262 4.262 0 0 1 3.037-1.25c1.147 0 2.222.444 3.028 1.25a4.245 4.245 0 0 1 1.256 3.019 4.236 4.236 0 0 1-1.25 3.019 4.336 4.336 0 0 1-3.047 1.25 4.136 4.136 0 0 1-2.159-.597l.003-3.688c0-.491.213-1.028.572-1.431a2.09 2.09 0 0 1 1.588-.716c.594 0 1.15.225 1.566.634.409.406.637.95.637 1.528a2.179 2.179 0 0 1-2.206 2.197c-.238 0-.672-.106-.691-.109-.25-.075-.356.272-.391.387-.134.441.069.528.109.541.397.125.659.147 1.003.147a3.173 3.173 0 0 0 3.169-3.169c0-1.734-1.422-3.144-3.166-3.144-.856 0-1.659.328-2.263.919-.575.566-.903 1.319-.903 2.069v.019c-.003.094-.003 2.306-.006 3.031l-.003-.003c-.328-.363-.653-.919-.869-1.488-.084-.222-.275-.184-.534-.103-.125.034-.469.141-.391.394zm3.722-.865c0 .106.097.2.156.253l.019.019c.1.097.194.147.281.147a.181.181 0 0 0 .131-.05c.044-.041.537-.544.588-.591l.553.55c.05.056.106.088.172.088.088 0 .184-.053.284-.156.238-.244.119-.375.063-.438l-.559-.559.584-.588c.128-.137.016-.284-.097-.397-.162-.162-.322-.206-.422-.112l-.581.581-.588-.588a.16.16 0 0 0-.113-.047c-.078 0-.172.053-.275.156-.181.181-.219.306-.125.406l.588.584-.584.584c-.053.05-.078.103-.075.156zm1.278-7.931c-.938 0-1.938.191-2.669.506a.207.207 0 0 0-.134.181.753.753 0 0 0 .069.337c.047.116.166.425.4.334a6.689 6.689 0 0 1 2.334-.444 6.35 6.35 0 0 1 2.469.497c.622.263 1.206.644 1.844 1.194a.22.22 0 0 0 .147.059c.125 0 .244-.122.347-.237.169-.191.287-.35.119-.509a6.858 6.858 0 0 0-2.1-1.356 7.326 7.326 0 0 0-2.825-.563zM14.006 13.3c-.113-.113-.209-.178-.294-.203s-.162-.006-.222.053l-.056.056a6.32 6.32 0 0 1-6.938 1.356 6.336 6.336 0 0 1-2.013-1.356 6.046 6.046 0 0 1-1.356-2.012c-.288-.713-.381-1.247-.413-1.422-.003-.016-.006-.028-.006-.037-.041-.206-.231-.222-.503-.178-.112.019-.459.072-.428.319v.006a7.261 7.261 0 0 0 2.04 3.994 7.266 7.266 0 0 0 10.288 0l.059-.059c.069-.084.134-.225-.159-.516z"/> </g></symbol> <symbol id="icon-codepen" viewBox="0 0 16 16"><g> <path d="M14.777 5.751l-7-4.667a.5.5 0 0 0-.555 0l-7 4.667a.501.501 0 0 0-.223.416v4.667c0 .167.084.323.223.416l7 4.667a.5.5 0 0 0 .554 0l7-4.667a.501.501 0 0 0 .223-.416V6.167a.501.501 0 0 0-.223-.416zM7.5 10.232L4.901 8.5 7.5 6.768 10.099 8.5 7.5 10.232zM8 5.899V2.434l5.599 3.732L11 7.898l-3-2zm-1 0l-3 2-2.599-1.732L7 2.435V5.9zM3.099 8.5L1 9.899V7.101L3.099 8.5zM4 9.101l3 2v3.465l-5.599-3.732L4 9.102zm4 2l3-2 2.599 1.732L8 14.565V11.1zM11.901 8.5L14 7.101v2.798L11.901 8.5z"/> </g></symbol> <symbol id="icon-dribbble" viewBox="0 0 16 16"><g> <path d="M8 16c-4.412 0-8-3.588-8-8s3.587-8 8-8c4.412 0 8 3.587 8 8s-3.588 8-8 8zm6.747-6.906c-.234-.075-2.116-.634-4.256-.291a29.7 29.7 0 0 1 1.328 4.872 6.845 6.845 0 0 0 2.928-4.581zM10.669 14.3c-.103-.6-.497-2.688-1.456-5.181-.016.006-.031.009-.044.016-3.856 1.344-5.241 4.016-5.362 4.266a6.807 6.807 0 0 0 6.863.9zm-7.747-1.722c.156-.266 2.031-3.369 5.553-4.509a7.04 7.04 0 0 1 .269-.081 24.04 24.04 0 0 0-.553-1.159c-3.409 1.022-6.722.978-7.022.975-.003.069-.003.138-.003.209 0 1.753.666 3.356 1.756 4.566zM1.313 6.609c.306.003 3.122.016 6.319-.831a43.092 43.092 0 0 0-2.534-3.953 6.854 6.854 0 0 0-3.784 4.784zM6.4 1.366a36.612 36.612 0 0 1 2.55 4c2.431-.909 3.459-2.294 3.581-2.469A6.799 6.799 0 0 0 6.4 1.366zm6.891 2.325c-.144.194-1.291 1.663-3.816 2.694.159.325.313.656.453.991.05.119.1.234.147.353 2.275-.284 4.534.172 4.759.219a6.816 6.816 0 0 0-1.544-4.256z"/> </g></symbol> <symbol id="icon-facebook" viewBox="0 0 16 16"><g> <path d="M9.5 3H12V0H9.5C7.57 0 6 1.57 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.271.229-.5.5-.5z"/> </g></symbol> <symbol id="icon-feed" viewBox="0 0 16 16"><g> <path d="M2.13 11.733c-1.175 0-2.13.958-2.13 2.126 0 1.174.955 2.122 2.13 2.122a2.126 2.126 0 0 0 2.133-2.122 2.133 2.133 0 0 0-2.133-2.126zM.002 5.436v3.067c1.997 0 3.874.781 5.288 2.196a7.45 7.45 0 0 1 2.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006 0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824 0 .006 0z"/> </g></symbol> <symbol id="icon-flickr" viewBox="0 0 16 16"><g> <path d="M0 8.5a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0zm9 0a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/> </g></symbol> <symbol id="icon-github" viewBox="0 0 16 16"><g> <path d="M8 .198a8 8 0 0 0-2.529 15.591c.4.074.547-.174.547-.385 0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954 0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117 0 0 .672-.215 2.201.82A7.672 7.672 0 0 1 8 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147 0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481 0 1.07-.009 1.932-.009 2.195 0 .213.144.462.55.384A8 8 0 0 0 8.001.196z"/> </g></symbol> <symbol id="icon-gitlab" viewBox="0 0 28 28"><g> <path d="M1.625 11.031L14 26.89.437 17.046a1.092 1.092 0 0 1-.391-1.203l1.578-4.813zm7.219 0h10.313L14.001 26.89zM5.75 1.469l3.094 9.562H1.625l3.094-9.562a.548.548 0 0 1 1.031 0zm20.625 9.562l1.578 4.813a1.09 1.09 0 0 1-.391 1.203l-13.563 9.844 12.375-15.859zm0 0h-7.219l3.094-9.562a.548.548 0 0 1 1.031 0z"/> </g></symbol> <symbol id="icon-google-plus" viewBox="0 0 16 16"><g> <path d="M5.091 7.147v1.747h2.888c-.116.75-.872 2.197-2.888 2.197-1.737 0-3.156-1.441-3.156-3.216s1.419-3.216 3.156-3.216c.991 0 1.65.422 2.028.784L8.5 4.112c-.888-.828-2.037-1.331-3.409-1.331C2.275 2.784 0 5.059 0 7.875s2.275 5.091 5.091 5.091c2.937 0 4.888-2.066 4.888-4.975 0-.334-.037-.591-.081-.844H5.092zM16 7h-1.5V5.5H13V7h-1.5v1.5H13V10h1.5V8.5H16z"/> </g></symbol> <symbol id="icon-instagram" viewBox="0 0 22 22"><g> <path d="M15.445 0H6.554A6.559 6.559 0 0 0 0 6.554v8.891A6.559 6.559 0 0 0 6.554 22h8.891a6.56 6.56 0 0 0 6.554-6.555V6.554A6.557 6.557 0 0 0 15.445 0zm4.342 15.445a4.343 4.343 0 0 1-4.342 4.342H6.554a4.341 4.341 0 0 1-4.341-4.342V6.554a4.34 4.34 0 0 1 4.341-4.341h8.891a4.342 4.342 0 0 1 4.341 4.341l.001 8.891z"/> <path d="M11 5.312A5.693 5.693 0 0 0 5.312 11 5.694 5.694 0 0 0 11 16.688 5.694 5.694 0 0 0 16.688 11 5.693 5.693 0 0 0 11 5.312zm0 9.163a3.475 3.475 0 1 1-.001-6.95 3.475 3.475 0 0 1 .001 6.95zm5.7-10.484a1.363 1.363 0 1 1-1.364 1.364c0-.752.51-1.364 1.364-1.364z"/> </g></symbol> <symbol id="icon-linkedin" viewBox="0 0 16 16"><g> <path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502 0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5a1.5 1.5 0 1 1-3.001-.001A1.5 1.5 0 0 1 4 3.5z"/> </g></symbol> <symbol id="icon-mail" viewBox="0 0 22 18"><g> <path fill="#000" d="M0 17.225V.776h22v16.447H0v.002zm3.011-1.815h15.978l-5.111-5.115L11 13.179l-2.877-2.883-5.112 5.114zm-1.216-1.275l5.077-5.09L1.795 3.98v10.155zm13.332-5.09l5.079 5.09V3.979l-5.079 5.066zm-4.126 1.588l8.022-8.027-16.045-.001 8.023 8.028z"/> </g></symbol> <symbol id="icon-medium" viewBox="0 0 24 24"><g> <path d="M22.085 4.733L24 2.901V2.5h-6.634l-4.728 11.768L7.259 2.5H.303v.401L2.54 5.594c.218.199.332.49.303.783V16.96c.069.381-.055.773-.323 1.05L0 21.064v.396h7.145v-.401l-2.52-3.049a1.244 1.244 0 0 1-.347-1.05V7.806l6.272 13.659h.729l5.393-13.659v10.881c0 .287 0 .346-.188.534l-1.94 1.877v.402h9.412v-.401l-1.87-1.831a.556.556 0 0 1-.214-.534V5.267a.554.554 0 0 1 .213-.534z"/> </g></symbol> <symbol id="icon-npm" viewBox="0 0 16 16"><g> <path d="M0 0v16h16V0H0zm13 13h-2V5H8v8H3V3h10v10z"/> </g></symbol> <symbol id="icon-pinterest" viewBox="0 0 16 16"><g> <path d="M8 1.069a6.93 6.93 0 0 0-2.525 13.384c-.059-.547-.116-1.391.025-1.988.125-.541.813-3.444.813-3.444s-.206-.416-.206-1.028c0-.963.559-1.684 1.253-1.684.591 0 .878.444.878.975 0 .594-.378 1.484-.575 2.306-.166.691.344 1.253 1.025 1.253 1.231 0 2.178-1.3 2.178-3.175 0-1.659-1.194-2.819-2.894-2.819-1.972 0-3.128 1.478-3.128 3.009 0 .597.228 1.234.516 1.581.056.069.066.128.047.2a95.89 95.89 0 0 1-.194.787c-.031.128-.1.153-.231.094-.866-.403-1.406-1.669-1.406-2.684 0-2.188 1.587-4.194 4.578-4.194 2.403 0 4.272 1.712 4.272 4.003 0 2.388-1.506 4.313-3.597 4.313-.703 0-1.362-.366-1.588-.797 0 0-.347 1.322-.431 1.647-.156.603-.578 1.356-.862 1.816a6.93 6.93 0 0 0 8.984-6.622 6.931 6.931 0 0 0-6.931-6.934z"/> </g></symbol> <symbol id="icon-search" viewBox="0 0 16 16"><g> <path d="M15.504 13.616l-3.79-3.223c-.392-.353-.811-.514-1.149-.499a6 6 0 1 0-.672.672c-.016.338.146.757.499 1.149l3.223 3.79c.552.613 1.453.665 2.003.115s.498-1.452-.115-2.003zM6 10a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/> </g></symbol> <symbol id="icon-tumblr" viewBox="0 0 16 16"><g> <path d="M9.001 7v3.659c0 .928-.012 1.463.086 1.727.098.262.342.534.609.691.354.212.758.318 1.214.318.81 0 1.289-.107 2.09-.633v2.405a9.089 9.089 0 0 1-1.833.639A7.93 7.93 0 0 1 9.369 16a4.9 4.9 0 0 1-1.725-.276 4.195 4.195 0 0 1-1.438-.79c-.398-.343-.672-.706-.826-1.091s-.23-.944-.23-1.676V6.556H3.003V4.29c.628-.204 1.331-.497 1.778-.877a4.386 4.386 0 0 0 1.08-1.374C6.133 1.505 6.32.825 6.422 0h2.579v4H13v3H9.001z"/> </g></symbol> <symbol id="icon-twitter" viewBox="0 0 16 16"><g> <path d="M16 3.538a6.461 6.461 0 0 1-1.884.516 3.301 3.301 0 0 0 1.444-1.816 6.607 6.607 0 0 1-2.084.797 3.28 3.28 0 0 0-2.397-1.034 3.28 3.28 0 0 0-3.197 4.028 9.321 9.321 0 0 1-6.766-3.431 3.284 3.284 0 0 0 1.015 4.381A3.301 3.301 0 0 1 .643 6.57v.041A3.283 3.283 0 0 0 3.277 9.83a3.291 3.291 0 0 1-1.485.057 3.293 3.293 0 0 0 3.066 2.281 6.586 6.586 0 0 1-4.862 1.359 9.286 9.286 0 0 0 5.034 1.475c6.037 0 9.341-5.003 9.341-9.341 0-.144-.003-.284-.009-.425a6.59 6.59 0 0 0 1.637-1.697z"/> </g></symbol> <symbol id="icon-vimeo" viewBox="0 0 16 16"><g> <path d="M15.994 4.281c-.072 1.556-1.159 3.691-3.263 6.397-2.175 2.825-4.016 4.241-5.522 4.241-.931 0-1.722-.859-2.366-2.581-.431-1.578-.859-3.156-1.291-4.734-.478-1.722-.991-2.581-1.541-2.581-.119 0-.538.253-1.256.753l-.753-.969c.791-.694 1.569-1.388 2.334-2.081 1.053-.909 1.844-1.387 2.372-1.438 1.244-.119 2.013.731 2.3 2.553.309 1.966.525 3.188.647 3.666.359 1.631.753 2.447 1.184 2.447.334 0 .838-.528 1.509-1.588.669-1.056 1.028-1.862 1.078-2.416.097-.912-.262-1.372-1.078-1.372a2.98 2.98 0 0 0-1.184.263c.787-2.575 2.287-3.825 4.506-3.753 1.641.044 2.416 1.109 2.322 3.194z"/> </g></symbol> <symbol id="icon-wordpress" viewBox="0 0 16 16"><g> <path d="M2 8c0 2.313 1.38 4.312 3.382 5.259L2.52 5.622A5.693 5.693 0 0 0 2 8zm10.05-.295c0-.722-.266-1.222-.495-1.612-.304-.482-.589-.889-.589-1.371 0-.537.418-1.037 1.008-1.037.027 0 .052.003.078.005A6.064 6.064 0 0 0 8 2.156 6.036 6.036 0 0 0 2.987 4.79c.141.004.274.007.386.007.627 0 1.599-.074 1.599-.074.323-.018.361.444.038.482 0 0-.325.037-.687.055l2.185 6.33 1.313-3.835-.935-2.495a12.304 12.304 0 0 1-.629-.055c-.323-.019-.285-.5.038-.482 0 0 .991.074 1.58.074.627 0 1.599-.074 1.599-.074.323-.018.362.444.038.482 0 0-.326.037-.687.055l2.168 6.282.599-1.947c.259-.809.457-1.389.457-1.889zm-3.945.806l-1.8 5.095a6.148 6.148 0 0 0 3.687-.093.52.52 0 0 1-.043-.081L8.105 8.511zm5.16-3.315c.026.186.04.386.04.601 0 .593-.114 1.259-.456 2.093l-1.833 5.16c1.784-1.013 2.983-2.895 2.983-5.051a5.697 5.697 0 0 0-.735-2.803zM8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm0 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14z"/> </g></symbol> <symbol id="icon-youtube" viewBox="0 0 16 16"><g> <path d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359 0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z"/> </g></symbol></svg>
  <header class="l-header">
    
    <p class="c-title p-title"><a href="https://marcinchmiel.com/" class="p-title__link">Marcin Chmiel</a></p>
    
    
    <p class="p-subtitle">
      This is where I share some of the things I happen to find interesting or helpful otherwise
    </p>
    
  </header>
  <main id="main" class="l-main">


<article class="p-article">
  <header>
    <h1>Polyglot assembly 101</h1>
    <div>
      <div class="c-time">
        Posted on
        <time datetime="2017-07-31T00:00:00Z">
          Jul 31, 2017
        </time>
      </div>
      
    </div>
  </header>
  
  <section id="js-article" class="p-article__body">
    <p>As promised in my <a href="https://marcinchmiel.com/articles/2017-05/the-somewhat-lengthy-hello-world-post/">somewhat lengthy &ldquo;Hello World&rdquo; post</a>, although much later than intended, I finally got down to writing a follow-up post.</p>
<p>I remember one of the very first lectures during my uni course &ndash; when <code>assembly</code> language was being introduced. Nothing too deep, really. However, I recall a statement being made, that probably still lives in the minds of the many that heard it (and perhaps even more that didn&rsquo;t). Namely &ndash; that <code>assembly</code> code is not <em>portable</em>.</p>
<p>In this post we&rsquo;re going to take a look at how misleading that statement is and explore writing <strong>polyglot assembly code</strong>.</p>
<h3 id="on-portability">On portability</h3>
<p>First of all let&rsquo;s take a look at the words <em>portability</em> and <em>polyglot</em> themselves. According to <a href="https://en.wikipedia.org/wiki/Software_portability">Wikipedia</a>, portability</p>
<blockquote>
<p>is the usability of the same software in different environments</p>
</blockquote>
<p>whereas <a href="https://en.wikipedia.org/wiki/Polyglot_(computing)">polyglot code</a></p>
<blockquote>
<p>is a computer program written in a valid form of multiple programming languages, which performs the same operations or output independent of the programming language used to compile or interpret it</p>
</blockquote>
<p>Knowing that, let us all agree &ndash; for the sake of this article &ndash; that the following is not a far-fetched statement: <em>Polyglot code is a subset of portable code</em>. While polyglot code might be used for different reasons, <em>polyglot machine code</em> most likely won&rsquo;t.</p>
<h3 id="so-whats-the-fuss">So, what&rsquo;s the fuss?</h3>
<p>I bet almost everyone (but the developers maybe) appreciates portable software. No matter the architecture, one can just compile what they need and use it. But what if there&rsquo;s a better way?</p>
<p>Obviously, I left a (blunt) hint in the previous section! <em>Polyglot code</em> is the <em><strong>better</strong></em> way to portability (at least from the end user&rsquo;s perspective). Have you ever been under the impression that compiling again is not necessary? Well, I have. What if I could just compile my code once and never have to worry about doing it again?</p>
<p>That&rsquo;s the whole idea behind <em>polyglot machine code</em>: write once &ndash; run everywhere.</p>
<p>But before we continue with writing our little polyglot, let&rsquo;s examine whether we need it at all.</p>
<h3 id="the-code">The Code</h3>
<p>For our tests we&rsquo;re going to use the following program, which just reads machine code from a file given as its argument and executes it.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;sys/mman.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;fcntl.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;limits.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define MAX_SIZE 2048</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#458;font-weight:bold">char</span> buf[MAX_SIZE];

<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span><span style="color:#000;font-weight:bold">*</span> argv) {
  <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span> filename <span style="color:#000;font-weight:bold">=</span> argv[<span style="color:#099">1</span>];

  <span style="color:#458;font-weight:bold">int</span> f <span style="color:#000;font-weight:bold">=</span> open(filename, O_RDONLY);  
  <span style="color:#458;font-weight:bold">int</span> size <span style="color:#000;font-weight:bold">=</span> read(f, buf, MAX_SIZE);

  size_t pagesize <span style="color:#000;font-weight:bold">=</span> getpagesize();
  size_t start <span style="color:#000;font-weight:bold">=</span> ((size_t) buf) <span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">-</span>pagesize;
  
  mprotect((<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>) start, MAX_SIZE, PROT_WRITE <span style="color:#000;font-weight:bold">|</span> PROT_EXEC);

  size_t bits <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>) <span style="color:#000;font-weight:bold">*</span> CHAR_BIT;
  printf(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Compiled for x86-%d</span><span style="color:#d14">\n</span><span style="color:#d14">&#34;</span>, bits);
  printf(<span style="color:#d14"></span><span style="color:#d14">&#34;</span><span style="color:#d14">Loaded %d bytes of code</span><span style="color:#d14">\n</span><span style="color:#d14">&#34;</span>, size);
    
  <span style="color:#458;font-weight:bold">void</span> (<span style="color:#000;font-weight:bold">*</span>fun)(<span style="color:#458;font-weight:bold">void</span>) <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">void</span> (<span style="color:#000;font-weight:bold">*</span>)(<span style="color:#458;font-weight:bold">void</span>)) buf;

  fun();
  
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}

</code></pre></div><p>Now, let&rsquo;s write a piece of assembly that will generate our machine code.</p>
<p>One thing to note before that: as I&rsquo;m writing this post, I&rsquo;m sitting on a Linux machine, hence the <a href="https://en.wikipedia.org/wiki/Application_binary_interface">ABI</a> is different from what you could see in the <a href="https://marcinchmiel.com/articles/2017-05/the-somewhat-lengthy-hello-world-post/">previous post</a> &ndash; for now you don&rsquo;t have to worry about it, I&rsquo;m going to cover this in the following post.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#000;font-weight:bold">BITS</span> <span style="color:#099">32</span>
	
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">eax</span>, <span style="color:#099">4</span>
	<span style="color:#900;font-weight:bold">push</span> 	<span style="color:#458;font-weight:bold">word</span> <span style="color:#099">0x0a74</span>
	<span style="color:#900;font-weight:bold">push</span> 	<span style="color:#458;font-weight:bold">dword</span> <span style="color:#099">0x69623233</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">ebx</span>, <span style="color:#099">1</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">ecx</span>, <span style="color:#0086b3">esp</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">edx</span>, <span style="color:#099">6</span>
	<span style="color:#900;font-weight:bold">int</span> 	<span style="color:#099">0x80</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">eax</span>, <span style="color:#099">1</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">ebx</span>, <span style="color:#099">123</span>
	<span style="color:#900;font-weight:bold">int</span> 	<span style="color:#099">0x80</span>
</code></pre></div><p>Since we only want to translate our assembly code into machine code there are no sections and global symbols, instead we&rsquo;re going to turn it into raw bytes using</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mewa@sea$ nasm poly32.asm -o poly32 <span style="color:#000;font-weight:bold">&amp;&amp;</span> hexdump -C poly32 <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#0086b3">echo</span> --- hex end <span style="color:#000;font-weight:bold">&amp;&amp;</span> ndisasm -b32 poly32
<span style="color:#099">00000000</span>  b8 <span style="color:#099">04</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">66</span> <span style="color:#099">68</span> <span style="color:#099">74</span>  0a <span style="color:#099">68</span> <span style="color:#099">33</span> <span style="color:#099">32</span> <span style="color:#099">62</span> <span style="color:#099">69</span> bb <span style="color:#099">01</span>  |.....fht.h32bi..|
<span style="color:#099">00000010</span>  <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">89</span> e1 ba <span style="color:#099">06</span> <span style="color:#099">00</span>  <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#0086b3">cd</span> <span style="color:#099">80</span> b8 <span style="color:#099">01</span> <span style="color:#099">00</span> <span style="color:#099">00</span>  |................|
<span style="color:#099">00000020</span>  <span style="color:#099">00</span> bb 7b <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#0086b3">cd</span> <span style="color:#099">80</span>                           |..<span style="color:#000;font-weight:bold">{</span>.....|
<span style="color:#099">00000028</span>
--- hex end
<span style="color:#099">00000000</span>  B804000000        mov eax,0x4
<span style="color:#099">00000005</span>  6668740A          push word 0xa74
<span style="color:#099">00000009</span>  <span style="color:#099">6833326269</span>        push dword 0x69623233
0000000E  BB01000000        mov ebx,0x1
<span style="color:#099">00000013</span>  89E1              mov ecx,esp
<span style="color:#099">00000015</span>  BA06000000        mov edx,0x6
0000001A  CD80              int 0x80
0000001C  B801000000        mov eax,0x1
<span style="color:#099">00000021</span>  BB7B000000        mov ebx,0x7b
<span style="color:#099">00000026</span>  CD80              int 0x80
</code></pre></div><p>Let&rsquo;s compile our tester program for 32 bit x86 architecture and check the result</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mewa@sea$ gcc -m32 tester.c -o tester
mewa@sea$ ./tester poly32; <span style="color:#0086b3">echo</span> <span style="color:#008080">$?</span>
Compiled <span style="color:#000;font-weight:bold">for</span> x86-32
Loaded <span style="color:#099">40</span> bytes of code
32bit
<span style="color:#099">123</span>
</code></pre></div><p>As expected, it worked. Now let&rsquo;s try it again for x86-64</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mewa@sea$ gcc -m64 tester.c -o tester
mewa@sea$ ./tester poly32; <span style="color:#0086b3">echo</span> <span style="color:#008080">$?</span>
Compiled <span style="color:#000;font-weight:bold">for</span> x86-64
Loaded <span style="color:#099">40</span> bytes of code
<span style="color:#099">123</span>
</code></pre></div><p>Ok, so we got the exit code at least. But where is the string that was supposed to be printed? Let&rsquo;s analyze what is happening.</p>
<ul>
<li>we are running a 64 bit program</li>
<li>we are then injecting 32 bit machine code into it</li>
<li>the <code>exit</code> syscall is working, since we got the <code>123</code> status code</li>
<li>the <code>write</code> syscall is somehow failing</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mewa@sea$ gdb ./tester
</code></pre></div><pre><code class="language-gdb" data-lang="gdb">(gdb) disas main
...
0x0000000000000815 &lt;+171&gt;:lea    0xbd(%rip),%rdi        # 0x8d9
0x000000000000081c &lt;+178&gt;:mov    $0x0,%eax
0x0000000000000821 &lt;+183&gt;:callq  0x600 &lt;printf@plt&gt;
0x0000000000000826 &lt;+188&gt;:lea    0x200853(%rip),%rax        # 0x201080 &lt;buf&gt;
0x000000000000082d &lt;+195&gt;:mov    %rax,-0x8(%rbp)
0x0000000000000831 &lt;+199&gt;:mov    -0x8(%rbp),%rax
0x0000000000000835 &lt;+203&gt;:callq  *%rax
0x0000000000000837 &lt;+205&gt;:mov    $0x0,%eax
...
(gdb) break *main+203
(gdb) disp/4i $rip
(gdb) r poly32
1: x/4i $rip
=&gt; 	0x555555554835 &lt;main+203&gt;:callq  *%rax
	0x555555554837 &lt;main+205&gt;:mov    $0x0,%eax
	0x55555555483c &lt;main+210&gt;:leaveq 
	0x55555555483d &lt;main+211&gt;:retq   
(gdb) si
1: x/4i $rip
=&gt; 	0x555555755080 &lt;buf&gt;:mov      $0x4,%eax
	0x555555755085 &lt;buf+5&gt;:pushw  $0xa74
	0x555555755089 &lt;buf+9&gt;:pushq  $0x69623233
	0x55555575508e &lt;buf+14&gt;:mov   $0x1,%ebx
(gdb) si 4
=&gt; 	0x555555755093 &lt;buf+19&gt;:mov    %esp,%ecx
	0x555555755095 &lt;buf+21&gt;:mov    $0x6,%edx
	0x55555575509a &lt;buf+26&gt;:int    $0x80		&lt;-- write syscall
	0x55555575509c &lt;buf+28&gt;:mov    $0x1,%eax
# let's examine the return code
(gdb) disp $eax
2: $eax = 4
(gdb) si 3
1: x/4i $rip
=&gt; 	0x55555575509c &lt;buf+28&gt;:mov    $0x1,%eax
	0x5555557550a1 &lt;buf+33&gt;:mov    $0x7b,%ebx
	0x5555557550a6 &lt;buf+38&gt;:int    $0x80
	0x5555557550a8 &lt;buf+40&gt;:add    %al,(%rax)
2: $eax = -14		&lt;-- we got an error! errno == 14
</code></pre><p>Aha! According to the headers it&rsquo;s <code>EFAULT</code>, meaning something is wrong with address of the string passed.</p>
<pre><code>#define EFAULT          14      /* Bad address */
</code></pre><pre><code class="language-gdb" data-lang="gdb">(gdb) info reg esp
esp	0xffffdf0e	-8434
(gdb) x/s $esp
0xffffffffffffdf0e:	&lt;error: Cannot access memory at address 0xffffffffffffdf0e&gt;
</code></pre><p>Let&rsquo;s see. What is the stack pointer register pointing to? The <strong>stack</strong> obviously. It&rsquo;s an address, which is 64 bits wide, due to our program having been compiled for x86-64. And <code>esp</code> is a <em>32 bit</em> register. That&rsquo;s why the address pointed to by the lower half of the 64 bit <code>rsp</code>, which holds the stack pointer in 64 bit programs, is not within our process&rsquo; address space and hence invalid!</p>
<p>On a side note &ndash; this is obviously a very lucky case, since we hit the backwards compatibility mode and our <code>int 0x80</code> syscalls were actually called, had it not existed it would&rsquo;ve result in a <strong>total disaster</strong> (a.k.a a crash).</p>
<p>Anyway, now that we know it could be useful to distinguish between our runtime architecture let&rsquo;s get to the whole point of this article.</p>
<h3 id="the-polyglot">The polyglot</h3>
<p>In order to proceed we&rsquo;ll need 64 bit specific machine code</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#000;font-weight:bold">BITS</span> <span style="color:#099">64</span>
	
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rax</span>, <span style="color:#099">1</span>
	<span style="color:#900;font-weight:bold">sub</span>	<span style="color:#0086b3">rsp</span>, <span style="color:#099">0x06</span>
	<span style="color:#900;font-weight:bold">mov</span>	<span style="color:#458;font-weight:bold">word</span> [<span style="color:#0086b3">rsp</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">4</span>], <span style="color:#099">0x0a74</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#458;font-weight:bold">dword</span> [<span style="color:#0086b3">rsp</span>], <span style="color:#099">0x69623436</span>
	<span style="color:#900;font-weight:bold">mov</span>	<span style="color:#0086b3">rdi</span>, <span style="color:#099">1</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rsi</span>, <span style="color:#0086b3">rsp</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rdx</span>, <span style="color:#099">6</span>
	<span style="color:#900;font-weight:bold">syscall</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rax</span>, <span style="color:#099">60</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rdi</span>, <span style="color:#099">123</span>
	<span style="color:#900;font-weight:bold">syscall</span>
</code></pre></div><p>Let&rsquo;s see if it works</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mewa@sea$ ./tester poly64; <span style="color:#0086b3">echo</span> <span style="color:#008080">$?</span>
Compiled <span style="color:#000;font-weight:bold">for</span> x86-64
Loaded <span style="color:#099">49</span> bytes of code
64bit
<span style="color:#099">123</span>
</code></pre></div><p>Now we have 2 separate machine codes and we need run them correspondingly.</p>
<p>In order to detect what architecture we are currently running on, we have to extract the difference in information available from running the same piece of machine code based on the architecture. This implies that such piece of code has to be valid for both x86-32 and x86-64 but at the same time give different results. Sounds tricky? It certainly is if you&rsquo;re not familiar with the opcodes and their extensions.</p>
<p>But first things first &ndash; I haven&rsquo;t mentioned what machine code <em>reallly</em> is. In order to give you a better view let&rsquo;s look closely what a CPU is and what it is not. First of all, it&rsquo;s not magic! It&rsquo;s entirely possible, although not the most convenient way imaginable, to write a program using nothing but raw sequences of bytes. That&rsquo;s because a CPU is just an electronic circuit that acts upon <em>instructions</em> given at its <em>input</em>. Based on what instruction is given it performs some computations, such as addition, decrementation, etc. While humans usually talk about instructions in general terms such as &ldquo;addition&rdquo;, CPUs are given numbers which describe (encode the information) what action to perform, e.g. for a x86-32 machine <code>inc eax</code> would be translated to byte <code>0x40</code>, whereas <code>inc ebx</code> to <code>0x41</code>. When the CPU encounters <code>0x40</code> at its input it will perform incrementation of the <code>eax</code> register. Such numbers are called <em>opcodes</em> and machine code is just a <em>sequence of opcodes</em>.</p>
<p>Luckily enough if you want to look for a specific opcode you don&rsquo;t have to dig through AMD&rsquo;s or Intel&rsquo;s manuals &ndash; there already exist dedicated resources that have this information extracted. If you&rsquo;re curious you can look <a href="http://ref.x86asm.net">here</a> for more information on this subject.</p>
<p>To distinguish between the x86-32 and x86-64 architectures I&rsquo;m going to use the exact <code>0x40</code> opcode. On x86-32, as mentioned above, it simply encodes an <a href="http://ref.x86asm.net/coder32.html#x40">incrementation</a> instruction. But on x86-64 it <a href="http://ref.x86asm.net/coder64.html#x40">describes</a> a REX prefix, so an opcode that is used to change the behaviour of an instruction. REX prefixes were only introduced on the x86-64 architecture and we&rsquo;re going to exploit that fact.</p>
<p>We&rsquo;re going to deliberately place a REX prefix that will change the way our program behaves.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#000;font-weight:bold">BITS</span> <span style="color:#099">32</span>
	
	<span style="color:#900;font-weight:bold">xor</span>	<span style="color:#0086b3">eax</span>, <span style="color:#0086b3">eax</span>
	<span style="color:#000;font-weight:bold">db</span>	<span style="color:#099">0x40</span>
	<span style="color:#900;font-weight:bold">mov</span>	<span style="color:#0086b3">bh</span>, <span style="color:#099">1</span>
	<span style="color:#900;font-weight:bold">test</span>	<span style="color:#0086b3">eax</span>, <span style="color:#0086b3">eax</span>
	<span style="color:#900;font-weight:bold">jz</span>	<span style="color:#008080">near</span> <span style="color:#008080">x64</span>
<span style="color:#900;font-weight:bold">x86:</span>
	<span style="color:#900;font-weight:bold">nop</span>			<span style="color:#998;font-style:italic">; x86-86 relevant code</span>
<span style="color:#900;font-weight:bold">x64:</span>
	<span style="color:#900;font-weight:bold">nop</span>			<span style="color:#998;font-style:italic">; x86-64 relevant code</span>
</code></pre></div><p>Let&rsquo;s use <code>ndisasm</code> to discover how our code would be interpreted.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mewa@sea:polyglot$ nasm stub.asm -o stub <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#0086b3">echo</span> --- <span style="color:#099">32</span> bit <span style="color:#000;font-weight:bold">&amp;&amp;</span> ndisasm -b32 stub <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#0086b3">echo</span> --- <span style="color:#099">64</span> bit <span style="color:#000;font-weight:bold">&amp;&amp;</span> ndisasm -b64 stub
--- <span style="color:#099">32</span> bit
<span style="color:#099">00000000</span>  31C0              xor eax,eax
<span style="color:#099">00000002</span>  <span style="color:#099">40</span>                inc eax
<span style="color:#099">00000003</span>  B701              mov bh,0x1
<span style="color:#099">00000005</span>  85C0              <span style="color:#0086b3">test</span> eax,eax
<span style="color:#099">00000007</span>  0F8401000000      jz near 0xe
0000000D  <span style="color:#099">90</span>                nop
0000000E  <span style="color:#099">90</span>                nop
--- <span style="color:#099">64</span> bit
<span style="color:#099">00000000</span>  31C0              xor eax,eax
<span style="color:#099">00000002</span>  40B701            mov dil,0x1
<span style="color:#099">00000005</span>  85C0              <span style="color:#0086b3">test</span> eax,eax
<span style="color:#099">00000007</span>  0F8401000000      jz near 0xe
0000000D  <span style="color:#099">90</span>                nop
0000000E  <span style="color:#099">90</span>                nop
</code></pre></div><p>As you can see, even though we have the same sequence of bytes, they will act differently. The 32 bit version will increment the <code>eax</code> register, while the 64 bit version won&rsquo;t. We&rsquo;re then testing against eax and jump to 64 bit code if it&rsquo;s zero.</p>
<p>Let&rsquo;s create our fully functional polyglot at last.</p>
<p>Here&rsquo;s the contents of <code>poly32.asm</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#000;font-weight:bold">BITS</span> <span style="color:#099">32</span>

	<span style="color:#900;font-weight:bold">xor</span> 	<span style="color:#0086b3">eax</span>, <span style="color:#0086b3">eax</span>
	<span style="color:#000;font-weight:bold">db</span>	<span style="color:#099">0x40</span>
	<span style="color:#900;font-weight:bold">mov</span>	<span style="color:#0086b3">bh</span>, <span style="color:#099">1</span>
	<span style="color:#900;font-weight:bold">test</span> 	<span style="color:#0086b3">eax</span>, <span style="color:#0086b3">eax</span>
	<span style="color:#900;font-weight:bold">jz</span>	<span style="color:#008080">x64</span>
	
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">eax</span>, <span style="color:#099">4</span>
	<span style="color:#900;font-weight:bold">push</span> 	<span style="color:#458;font-weight:bold">word</span> <span style="color:#099">0x0a74</span>
	<span style="color:#900;font-weight:bold">push</span> 	<span style="color:#458;font-weight:bold">dword</span> <span style="color:#099">0x69623233</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">ebx</span>, <span style="color:#099">0</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">ecx</span>, <span style="color:#0086b3">esp</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">edx</span>, <span style="color:#099">6</span>
	<span style="color:#900;font-weight:bold">int</span> 	<span style="color:#099">0x80</span>
	<span style="color:#900;font-weight:bold">mov</span>	<span style="color:#0086b3">eax</span>, <span style="color:#099">1</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">ebx</span>, <span style="color:#099">123</span>
	<span style="color:#900;font-weight:bold">int</span> 	<span style="color:#099">0x80</span>
<span style="color:#900;font-weight:bold">x64:</span>
</code></pre></div><p>and <code>poly64.asm</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#000;font-weight:bold">BITS</span> <span style="color:#099">64</span>

	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rax</span>, <span style="color:#099">1</span>
	<span style="color:#900;font-weight:bold">sub</span>	<span style="color:#0086b3">rsp</span>, <span style="color:#099">0x06</span>
	<span style="color:#900;font-weight:bold">mov</span>	<span style="color:#458;font-weight:bold">word</span> [<span style="color:#0086b3">rsp</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">4</span>], <span style="color:#099">0x0a74</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#458;font-weight:bold">dword</span> [<span style="color:#0086b3">rsp</span>], <span style="color:#099">0x69623436</span>
	<span style="color:#900;font-weight:bold">xor</span>	<span style="color:#0086b3">edi</span>, <span style="color:#0086b3">edi</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rsi</span>, <span style="color:#0086b3">rsp</span>
	<span style="color:#900;font-weight:bold">xor</span> 	<span style="color:#0086b3">edx</span>, <span style="color:#0086b3">edx</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rdx</span>, <span style="color:#099">6</span>
	<span style="color:#900;font-weight:bold">syscall</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rax</span>, <span style="color:#099">60</span>
	<span style="color:#900;font-weight:bold">mov</span> 	<span style="color:#0086b3">rdi</span>, <span style="color:#099">123</span>
	<span style="color:#900;font-weight:bold">syscall</span>
</code></pre></div><p>Let&rsquo;s combine it together</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mewa@sea$ nasm poly32.asm -o poly32 <span style="color:#000;font-weight:bold">&amp;&amp;</span> nasm poly64.asm -o poly64
mewa@sea$ cat poly32 &gt; poly <span style="color:#000;font-weight:bold">&amp;&amp;</span> cat poly64 &gt;&gt; poly
</code></pre></div><p>The last thing remaining on our list is to test our little polyglot and see if it works!</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mewa@sea$ gcc -m32 tester.c -o tester <span style="color:#000;font-weight:bold">&amp;&amp;</span> ./tester poly; <span style="color:#0086b3">echo</span> <span style="color:#008080">$?</span>
Compiled <span style="color:#000;font-weight:bold">for</span> x86-32
Loaded <span style="color:#099">103</span> bytes of code
32bit
<span style="color:#099">123</span>
mewa@sea$ gcc -m64 tester.c -o tester <span style="color:#000;font-weight:bold">&amp;&amp;</span> ./tester poly; <span style="color:#0086b3">echo</span> <span style="color:#008080">$?</span>
Compiled <span style="color:#000;font-weight:bold">for</span> x86-64
Loaded <span style="color:#099">103</span> bytes of code
64bit
<span style="color:#099">123</span>
</code></pre></div><h3 id="great-success">Great success!</h3>
<p>We have successfully constructed our first polyglot!</p>
<p>If you want to give it a try yourself all the sources are available on my <a href="https://github.com/mewa/polyglot-101">GitHub</a>.</p>
<p>As promised, we&rsquo;ll continue to explore the world of <em>machine code polyglots</em> and in the upcoming post we&rsquo;re going to take a look at how to handle different operating systems and tackle with their ABIs.</p>
<p>I hope you enjoyed this mini article and as always &ndash; I encourage you to discuss further and leave your comments below!</p>
  </section>
  <footer>
    
    <nav class="p-pagination c-pagination">
      <div class="c-pagination__ctrl">
        <div class="c-pagination__newer">
          
          <a href="https://marcinchmiel.com/articles/2017-09/launching-terminal-emulator-in-current-working-directory-in-xmonad/">Newer</a>
          
        </div>
        <div class="c-pagination__older">
          
          <a href="https://marcinchmiel.com/articles/2017-05/kotlin-with-dagger-android-basic-setup/">Older</a>
          
        </div>
      </div>
    </nav>
    


    
<aside class="p-author">
  
  <div class="c-avatar p-author__avatar">
    <img alt="Author Avatar" src="../../../img/avatar.jpg" />
  </div>
  
  
  <div class="p-author__body">
    
    <p class="c-title p-author__name ">Marcin Chmiel</p>
    
    
    <p>I&#39;m passionate about cloud technologies, in particular containers &amp; serverless - and how they enable businesses to accelerate like never before. I love cutting hefty bills and automating things. I&#39;m also an AWS certified Solutions Architect - let&#39;s get in touch to kickstart your business&#39; cloud transformation.</p>
    
    
    <p>
      <a href="mailto:m@marcinchmiel.com">
        Contact me
      </a>
    </p>
    
  </div>
  
</aside>


  </footer>
</article>
  </main>
  
<nav class="l-nav p-menu">
  <ul class="p-menu__lists">
    
      
      <li class="p-menu__listitem">
        <a href="../../../">Blog</a>
      </li>
      
    
      
      <li class="p-menu__listitem">
        <a href="../../../categories/">Categories</a>
      </li>
      
    
  </ul>
</nav>


  <footer class="l-footer">
    
<ul class="c-links">
  
  
  <li class="c-links__item">
    <a href="https://twitter.com/marcin_chm" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>twitter</title>
        <use xlink:href="#icon-twitter"></use>
      </svg>
    </a>
  </li>
  
  
  
  
  
  <li class="c-links__item">
    <a href="https://github.com/mewa" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>github</title>
        <use xlink:href="#icon-github"></use>
      </svg>
    </a>
  </li>
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="c-links__item">
    <a href="https://linkedin.com/in/mkchmiel" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>linkedin</title>
        <use xlink:href="#icon-linkedin"></use>
      </svg>
    </a>
  </li>
  
</ul>



    <p class="p-copyright">
      
        
          
            Marcin Chmiel
          
        
        &nbsp;&bull;&nbsp;
        2020

        
          &nbsp;&bull;&nbsp;
          <a href="https://marcinchmiel.com/">Marcin Chmiel</a>
        
      
    </p>
  </footer>

</body>
</html>

